# Use a specific, modern PHP 8.x Apache image
FROM php:8.1-apache

LABEL maintainer="george@dawouds.com"
# Keep the original maintainer label

EXPOSE 80

# Install necessary system dependencies for PHP extensions and common utilities
RUN apt-get update && \
    apt-get install -y \
    libxml2-dev \
    gettext \
    locales \
    locales-all \
    libpng-dev \
    libzip-dev \
    libfreetype6-dev \
    libjpeg-dev \
    libonig-dev \
     # Added for mbstring (from our earlier troubleshooting)
    libcurl4-openssl-dev \
    # Added for curl (from our earlier troubleshooting)
    git \
     # Added for Composer/dependencies
    && rm -rf /var/lib/apt/lists/*
    # Clean up apt cache to reduce image size

# Install common PHP extensions
RUN docker-php-ext-install -j$(nproc) \
    xml \
    exif \
    pdo_mysql \
    gettext \
    iconv \
    mysqli \
    zip \
    curl \
    mbstring # Ensure mbstring is installed

RUN docker-php-ext-configure gd --with-freetype --with-jpeg
RUN docker-php-ext-install -j$(nproc) gd

# Configure PHP settings (from the original Dockerfile)
RUN mv "$PHP_INI_DIR/php.ini-production" "$PHP_INI_DIR/php.ini" && \
    sed -i 's/^upload_max_filesize.*$/upload_max_filesize = 2G/g' $PHP_INI_DIR/php.ini && \
    sed -i 's/^post_max_size.*$/post_max_size = 2G/g' $PHP_INI_DIR/php.ini && \
    sed -i 's/^memory_limit.*$/memory_limit = 2G/g' $PHP_INI_DIR/php.ini && \
    sed -i 's/^max_execution_time.*$/max_execution_time = 120/g' $PHP_INI_DIR/php.ini

# Install Composer
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# Copy your entire ChurchCRM application code into a specific directory inside the container
COPY . /var/www/html/churchcrm

# Set the working directory to the application root inside the container
WORKDIR /var/www/html/churchcrm

# Run Composer to install PHP dependencies with increased memory limit
# This command failed before, so we must be sure the local composer.lock is good
RUN php -d memory_limit=-1 /usr/local/bin/composer install --no-dev --optimize-autoloader --no-interaction

# Set appropriate permissions for writable directories (ChurchCRM needs these)
# Adjust these paths if ChurchCRM's writable folders are different or in subdirectories
RUN chown -R www-data:www-data src/temp src/session src/Images/Person src/Images/Family && \
    chmod -R 775 src/temp src/session src/Images/Person src/Images/Family

# --- Apache Configuration ---
# Instead of replacing apache2.conf, we'll use a virtual host for clarity and control.
# Create the directory for sites-available if it doesn't exist (it usually does)
RUN mkdir -p /etc/apache2/sites-available/
# Copy our custom virtual host config for ChurchCRM
COPY docker/apache/churchcrm.conf /etc/apache2/sites-available/churchcrm.conf
# Disable the default Apache site and enable our ChurchCRM site
RUN a2dissite 000-default.conf || true && \
 # Use || true to prevent build failure if 000-default.conf isn't found
    a2ensite churchcrm.conf && \
    a2enmod rewrite

# The base image already has Apache configured to serve.
# This CMD ensures Apache stays in the foreground for Docker.
CMD ["apache2ctl", "-D", "FOREGROUND"]